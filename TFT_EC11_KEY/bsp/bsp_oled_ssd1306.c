/**
 * @file bsp_oled_ssd1306.c
 * @brief SSD1306 OLED显示驱动实现
 * @author Claude Code
 * @version 1.0.0
 * @date 2025-12-12
 */

#include "bsp_oled_ssd1306.h"
#include "stm32f4xx.h"
#include <string.h>
#include <stdio.h>
#include <stdarg.h>

/*=============================================================================
 *                              私有变量
 *============================================================================*/

/* 显存缓冲区 */
static uint8_t oled_buffer[OLED_WIDTH * OLED_PAGES];

/* 当前OLED类型 */
static uint8_t current_oled_type = OLED_TYPE;
static uint8_t current_height = OLED_HEIGHT;
static uint8_t current_pages = OLED_PAGES;

/* 延时函数 */
extern void delay_ms(uint32_t ms);
extern void delay_us(uint32_t us);

/*=============================================================================
 *                              内置字体数据
 *============================================================================*/

/* 6x8 ASCII字体 (0x20-0x7F) */
static const uint8_t font_6x8_data[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // sp
    0x00, 0x00, 0x00, 0x2f, 0x00, 0x00, // !
    0x00, 0x00, 0x07, 0x00, 0x07, 0x00, // "
    0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14, // #
    0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12, // $
    0x00, 0x23, 0x13, 0x08, 0x64, 0x62, // %
    0x00, 0x36, 0x49, 0x55, 0x22, 0x50, // &
    0x00, 0x00, 0x05, 0x03, 0x00, 0x00, // '
    0x00, 0x00, 0x1c, 0x22, 0x41, 0x00, // (
    0x00, 0x00, 0x41, 0x22, 0x1c, 0x00, // )
    0x00, 0x14, 0x08, 0x3E, 0x08, 0x14, // *
    0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, // +
    0x00, 0x00, 0x00, 0xA0, 0x60, 0x00, // ,
    0x00, 0x08, 0x08, 0x08, 0x08, 0x08, // -
    0x00, 0x00, 0x60, 0x60, 0x00, 0x00, // .
    0x00, 0x20, 0x10, 0x08, 0x04, 0x02, // /
    0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E, // 0
    0x00, 0x00, 0x42, 0x7F, 0x40, 0x00, // 1
    0x00, 0x42, 0x61, 0x51, 0x49, 0x46, // 2
    0x00, 0x21, 0x41, 0x45, 0x4B, 0x31, // 3
    0x00, 0x18, 0x14, 0x12, 0x7F, 0x10, // 4
    0x00, 0x27, 0x45, 0x45, 0x45, 0x39, // 5
    0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30, // 6
    0x00, 0x01, 0x71, 0x09, 0x05, 0x03, // 7
    0x00, 0x36, 0x49, 0x49, 0x49, 0x36, // 8
    0x00, 0x06, 0x49, 0x49, 0x29, 0x1E, // 9
    0x00, 0x00, 0x36, 0x36, 0x00, 0x00, // :
    0x00, 0x00, 0x56, 0x36, 0x00, 0x00, // ;
    0x00, 0x08, 0x14, 0x22, 0x41, 0x00, // <
    0x00, 0x14, 0x14, 0x14, 0x14, 0x14, // =
    0x00, 0x00, 0x41, 0x22, 0x14, 0x08, // >
    0x00, 0x02, 0x01, 0x51, 0x09, 0x06, // ?
    0x00, 0x32, 0x49, 0x59, 0x51, 0x3E, // @
    0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C, // A
    0x00, 0x7F, 0x49, 0x49, 0x49, 0x36, // B
    0x00, 0x3E, 0x41, 0x41, 0x41, 0x22, // C
    0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C, // D
    0x00, 0x7F, 0x49, 0x49, 0x49, 0x41, // E
    0x00, 0x7F, 0x09, 0x09, 0x09, 0x01, // F
    0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A, // G
    0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F, // H
    0x00, 0x00, 0x41, 0x7F, 0x41, 0x00, // I
    0x00, 0x20, 0x40, 0x41, 0x3F, 0x01, // J
    0x00, 0x7F, 0x08, 0x14, 0x22, 0x41, // K
    0x00, 0x7F, 0x40, 0x40, 0x40, 0x40, // L
    0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F, // M
    0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F, // N
    0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E, // O
    0x00, 0x7F, 0x09, 0x09, 0x09, 0x06, // P
    0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E, // Q
    0x00, 0x7F, 0x09, 0x19, 0x29, 0x46, // R
    0x00, 0x46, 0x49, 0x49, 0x49, 0x31, // S
    0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, // T
    0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F, // U
    0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F, // V
    0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F, // W
    0x00, 0x63, 0x14, 0x08, 0x14, 0x63, // X
    0x00, 0x07, 0x08, 0x70, 0x08, 0x07, // Y
    0x00, 0x61, 0x51, 0x49, 0x45, 0x43, // Z
    0x00, 0x00, 0x7F, 0x41, 0x41, 0x00, // [
    0x00, 0x02, 0x04, 0x08, 0x10, 0x20, // backslash
    0x00, 0x00, 0x41, 0x41, 0x7F, 0x00, // ]
    0x00, 0x04, 0x02, 0x01, 0x02, 0x04, // ^
    0x00, 0x40, 0x40, 0x40, 0x40, 0x40, // _
    0x00, 0x00, 0x01, 0x02, 0x04, 0x00, // `
    0x00, 0x20, 0x54, 0x54, 0x54, 0x78, // a
    0x00, 0x7F, 0x48, 0x44, 0x44, 0x38, // b
    0x00, 0x38, 0x44, 0x44, 0x44, 0x20, // c
    0x00, 0x38, 0x44, 0x44, 0x48, 0x7F, // d
    0x00, 0x38, 0x54, 0x54, 0x54, 0x18, // e
    0x00, 0x08, 0x7E, 0x09, 0x01, 0x02, // f
    0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C, // g
    0x00, 0x7F, 0x08, 0x04, 0x04, 0x78, // h
    0x00, 0x00, 0x44, 0x7D, 0x40, 0x00, // i
    0x00, 0x40, 0x80, 0x84, 0x7D, 0x00, // j
    0x00, 0x7F, 0x10, 0x28, 0x44, 0x00, // k
    0x00, 0x00, 0x41, 0x7F, 0x40, 0x00, // l
    0x00, 0x7C, 0x04, 0x18, 0x04, 0x78, // m
    0x00, 0x7C, 0x08, 0x04, 0x04, 0x78, // n
    0x00, 0x38, 0x44, 0x44, 0x44, 0x38, // o
    0x00, 0xFC, 0x24, 0x24, 0x24, 0x18, // p
    0x00, 0x18, 0x24, 0x24, 0x18, 0xFC, // q
    0x00, 0x7C, 0x08, 0x04, 0x04, 0x08, // r
    0x00, 0x48, 0x54, 0x54, 0x54, 0x20, // s
    0x00, 0x04, 0x3F, 0x44, 0x40, 0x20, // t
    0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C, // u
    0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C, // v
    0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C, // w
    0x00, 0x44, 0x28, 0x10, 0x28, 0x44, // x
    0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C, // y
    0x00, 0x44, 0x64, 0x54, 0x4C, 0x44, // z
    0x00, 0x00, 0x08, 0x36, 0x41, 0x00, // {
    0x00, 0x00, 0x00, 0x7F, 0x00, 0x00, // |
    0x00, 0x00, 0x41, 0x36, 0x08, 0x00, // }
    0x00, 0x08, 0x04, 0x08, 0x10, 0x08, // ~
};

/* 8x16 ASCII字体 (0x20-0x7F) - 简化版 */
static const uint8_t font_8x16_data[] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // sp
    0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x30,0x00,0x00,0x00, // !
    0x00,0x10,0x0C,0x06,0x10,0x0C,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // "
    0x40,0xC0,0x78,0x40,0xC0,0x78,0x40,0x00,0x04,0x3F,0x04,0x04,0x3F,0x04,0x04,0x00, // #
    0x00,0x70,0x88,0xFC,0x08,0x30,0x00,0x00,0x00,0x18,0x20,0xFF,0x21,0x1E,0x00,0x00, // $
    0xF0,0x08,0xF0,0x00,0xE0,0x18,0x00,0x00,0x00,0x21,0x1C,0x03,0x1E,0x21,0x1E,0x00, // %
    0x00,0xF0,0x08,0x88,0x70,0x00,0x00,0x00,0x1E,0x21,0x23,0x24,0x19,0x27,0x21,0x10, // &
    0x10,0x16,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // '
    0x00,0x00,0x00,0xE0,0x18,0x04,0x02,0x00,0x00,0x00,0x00,0x07,0x18,0x20,0x40,0x00, // (
    0x00,0x02,0x04,0x18,0xE0,0x00,0x00,0x00,0x00,0x40,0x20,0x18,0x07,0x00,0x00,0x00, // )
    0x40,0x40,0x80,0xF0,0x80,0x40,0x40,0x00,0x02,0x02,0x01,0x0F,0x01,0x02,0x02,0x00, // *
    0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x1F,0x01,0x01,0x01,0x00, // +
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xB0,0x70,0x00,0x00,0x00,0x00,0x00, // ,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01, // -
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00, // .
    0x00,0x00,0x00,0x00,0x80,0x60,0x18,0x04,0x00,0x60,0x18,0x06,0x01,0x00,0x00,0x00, // /
    0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x0F,0x10,0x20,0x20,0x10,0x0F,0x00, // 0
    0x00,0x10,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00, // 1
    0x00,0x70,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x30,0x28,0x24,0x22,0x21,0x30,0x00, // 2
    0x00,0x30,0x08,0x88,0x88,0x48,0x30,0x00,0x00,0x18,0x20,0x20,0x20,0x11,0x0E,0x00, // 3
    0x00,0x00,0xC0,0x20,0x10,0xF8,0x00,0x00,0x00,0x07,0x04,0x24,0x24,0x3F,0x24,0x00, // 4
    0x00,0xF8,0x08,0x88,0x88,0x08,0x08,0x00,0x00,0x19,0x21,0x20,0x20,0x11,0x0E,0x00, // 5
    0x00,0xE0,0x10,0x88,0x88,0x18,0x00,0x00,0x00,0x0F,0x11,0x20,0x20,0x11,0x0E,0x00, // 6
    0x00,0x38,0x08,0x08,0xC8,0x38,0x08,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00, // 7
    0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x1C,0x22,0x21,0x21,0x22,0x1C,0x00, // 8
    0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x00,0x31,0x22,0x22,0x11,0x0F,0x00, // 9
    0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00, // :
    0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x60,0x00,0x00,0x00,0x00, // ;
    0x00,0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00,0x01,0x02,0x04,0x08,0x10,0x20,0x00, // <
    0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x00,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x00, // =
    0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x01,0x00, // >
    0x00,0x70,0x48,0x08,0x08,0x08,0xF0,0x00,0x00,0x00,0x00,0x30,0x36,0x01,0x00,0x00, // ?
    0xC0,0x30,0xC8,0x28,0xE8,0x10,0xE0,0x00,0x07,0x18,0x27,0x24,0x23,0x14,0x0B,0x00, // @
    0x00,0x00,0xC0,0x38,0xE0,0x00,0x00,0x00,0x20,0x3C,0x23,0x02,0x02,0x27,0x38,0x20, // A
    0x08,0xF8,0x88,0x88,0x88,0x70,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x11,0x0E,0x00, // B
    0xC0,0x30,0x08,0x08,0x08,0x08,0x38,0x00,0x07,0x18,0x20,0x20,0x20,0x10,0x08,0x00, // C
    0x08,0xF8,0x08,0x08,0x08,0x10,0xE0,0x00,0x20,0x3F,0x20,0x20,0x20,0x10,0x0F,0x00, // D
    0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x20,0x23,0x20,0x18,0x00, // E
    0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x00,0x03,0x00,0x00,0x00, // F
    0xC0,0x30,0x08,0x08,0x08,0x38,0x00,0x00,0x07,0x18,0x20,0x20,0x22,0x1E,0x02,0x00, // G
    0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x20,0x3F,0x21,0x01,0x01,0x21,0x3F,0x20, // H
    0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00, // I
    0x00,0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,0x00, // J
    0x08,0xF8,0x88,0xC0,0x28,0x18,0x08,0x00,0x20,0x3F,0x20,0x01,0x26,0x38,0x20,0x00, // K
    0x08,0xF8,0x08,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x20,0x30,0x00, // L
    0x08,0xF8,0xF8,0x00,0xF8,0xF8,0x08,0x00,0x20,0x3F,0x00,0x3F,0x00,0x3F,0x20,0x00, // M
    0x08,0xF8,0x30,0xC0,0x00,0x08,0xF8,0x08,0x20,0x3F,0x20,0x00,0x07,0x18,0x3F,0x00, // N
    0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x10,0x20,0x20,0x20,0x10,0x0F,0x00, // O
    0x08,0xF8,0x08,0x08,0x08,0x08,0xF0,0x00,0x20,0x3F,0x21,0x01,0x01,0x01,0x00,0x00, // P
    0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x18,0x24,0x24,0x38,0x50,0x4F,0x00, // Q
    0x08,0xF8,0x88,0x88,0x88,0x88,0x70,0x00,0x20,0x3F,0x20,0x00,0x03,0x0C,0x30,0x20, // R
    0x00,0x70,0x88,0x08,0x08,0x08,0x38,0x00,0x00,0x38,0x20,0x21,0x21,0x22,0x1C,0x00, // S
    0x18,0x08,0x08,0xF8,0x08,0x08,0x18,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00, // T
    0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00, // U
    0x08,0x78,0x88,0x00,0x00,0xC8,0x38,0x08,0x00,0x00,0x07,0x38,0x0E,0x01,0x00,0x00, // V
    0xF8,0x08,0x00,0xF8,0x00,0x08,0xF8,0x00,0x03,0x3C,0x07,0x00,0x07,0x3C,0x03,0x00, // W
    0x08,0x18,0x68,0x80,0x80,0x68,0x18,0x08,0x20,0x30,0x2C,0x03,0x03,0x2C,0x30,0x20, // X
    0x08,0x38,0xC8,0x00,0xC8,0x38,0x08,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00, // Y
    0x10,0x08,0x08,0x08,0xC8,0x38,0x08,0x00,0x20,0x38,0x26,0x21,0x20,0x20,0x18,0x00, // Z
    0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x7F,0x40,0x40,0x40,0x00, // [
    0x00,0x0C,0x30,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x06,0x38,0xC0,0x00, // backslash
    0x00,0x02,0x02,0x02,0xFE,0x00,0x00,0x00,0x00,0x40,0x40,0x40,0x7F,0x00,0x00,0x00, // ]
    0x00,0x00,0x04,0x02,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ^
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80, // _
    0x00,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // `
    0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x19,0x24,0x22,0x22,0x22,0x3F,0x20, // a
    0x08,0xF8,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x3F,0x11,0x20,0x20,0x11,0x0E,0x00, // b
    0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00,0x00,0x0E,0x11,0x20,0x20,0x20,0x11,0x00, // c
    0x00,0x00,0x00,0x80,0x80,0x88,0xF8,0x00,0x00,0x0E,0x11,0x20,0x20,0x10,0x3F,0x20, // d
    0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x22,0x22,0x22,0x22,0x13,0x00, // e
    0x00,0x80,0x80,0xF0,0x88,0x88,0x88,0x18,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00, // f
    0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x6B,0x94,0x94,0x94,0x93,0x60,0x00, // g
    0x08,0xF8,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x3F,0x21,0x00,0x00,0x20,0x3F,0x20, // h
    0x00,0x80,0x98,0x98,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00, // i
    0x00,0x00,0x00,0x80,0x98,0x98,0x00,0x00,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00, // j
    0x08,0xF8,0x00,0x00,0x80,0x80,0x80,0x00,0x20,0x3F,0x24,0x02,0x2D,0x30,0x20,0x00, // k
    0x00,0x08,0x08,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00, // l
    0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x20,0x3F,0x20,0x00,0x3F,0x20,0x00,0x3F, // m
    0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x3F,0x21,0x00,0x00,0x20,0x3F,0x20, // n
    0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00, // o
    0x80,0x80,0x00,0x80,0x80,0x00,0x00,0x00,0x80,0xFF,0xA1,0x20,0x20,0x11,0x0E,0x00, // p
    0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x0E,0x11,0x20,0x20,0xA0,0xFF,0x80, // q
    0x80,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x20,0x20,0x3F,0x21,0x20,0x00,0x01,0x00, // r
    0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x33,0x24,0x24,0x24,0x24,0x19,0x00, // s
    0x00,0x80,0x80,0xE0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x1F,0x20,0x20,0x00,0x00, // t
    0x80,0x80,0x00,0x00,0x00,0x80,0x80,0x00,0x00,0x1F,0x20,0x20,0x20,0x10,0x3F,0x20, // u
    0x80,0x80,0x80,0x00,0x00,0x80,0x80,0x80,0x00,0x01,0x0E,0x30,0x08,0x06,0x01,0x00, // v
    0x80,0x80,0x00,0x80,0x00,0x80,0x80,0x80,0x0F,0x30,0x0C,0x03,0x0C,0x30,0x0F,0x00, // w
    0x00,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x31,0x2E,0x0E,0x31,0x20,0x00, // x
    0x80,0x80,0x80,0x00,0x00,0x80,0x80,0x80,0x80,0x81,0x8E,0x70,0x18,0x06,0x01,0x00, // y
    0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x21,0x30,0x2C,0x22,0x21,0x30,0x00, // z
    0x00,0x00,0x00,0x00,0x80,0x7C,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x3F,0x40,0x40, // {
    0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00, // |
    0x00,0x02,0x02,0x7C,0x80,0x00,0x00,0x00,0x00,0x40,0x40,0x3F,0x00,0x00,0x00,0x00, // }
    0x00,0x06,0x01,0x01,0x02,0x02,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ~
};

/* 字体结构体实例 */
const oled_font_t oled_font_6x8 = {
    .width = 6,
    .height = 8,
    .data = font_6x8_data
};

const oled_font_t oled_font_8x16 = {
    .width = 8,
    .height = 16,
    .data = font_8x16_data
};

/*=============================================================================
 *                              私有函数声明
 *============================================================================*/

static void oled_write_cmd(uint8_t cmd);
static void oled_write_data(uint8_t data);
static void oled_write_data_buffer(const uint8_t *data, uint16_t len);
static void oled_gpio_init(void);
static void oled_i2c_init(void);

#if OLED_USE_SW_I2C
static void sw_i2c_start(void);
static void sw_i2c_stop(void);
static void sw_i2c_write_byte(uint8_t data);
#endif

/*=============================================================================
 *                              I2C底层函数
 *============================================================================*/

#if OLED_USE_HW_I2C

/**
 * @brief 硬件I2C初始化
 */
static void oled_i2c_init(void)
{
    GPIO_InitTypeDef GPIO_InitStructure;
    I2C_InitTypeDef I2C_InitStructure;

    /* 使能时钟 */
    RCC_AHB1PeriphClockCmd(OLED_I2C_GPIO_CLK, ENABLE);
    RCC_APB1PeriphClockCmd(OLED_I2C_PERIPH_CLK, ENABLE);

    /* 配置I2C引脚 */
    GPIO_InitStructure.GPIO_Pin = OLED_I2C_SCL_PIN | OLED_I2C_SDA_PIN;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_InitStructure.GPIO_OType = GPIO_OType_OD;
    GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;
    GPIO_Init(OLED_I2C_SCL_PORT, &GPIO_InitStructure);

    /* 复用功能 */
    GPIO_PinAFConfig(OLED_I2C_SCL_PORT, GPIO_PinSource6, GPIO_AF_I2C1);
    GPIO_PinAFConfig(OLED_I2C_SDA_PORT, GPIO_PinSource7, GPIO_AF_I2C1);

    /* I2C配置 */
    I2C_DeInit(OLED_I2C_PORT);
    I2C_InitStructure.I2C_Mode = I2C_Mode_I2C;
    I2C_InitStructure.I2C_DutyCycle = I2C_DutyCycle_2;
    I2C_InitStructure.I2C_OwnAddress1 = 0x00;
    I2C_InitStructure.I2C_Ack = I2C_Ack_Enable;
    I2C_InitStructure.I2C_AcknowledgedAddress = I2C_AcknowledgedAddress_7bit;
    I2C_InitStructure.I2C_ClockSpeed = OLED_I2C_SPEED;
    I2C_Init(OLED_I2C_PORT, &I2C_InitStructure);

    I2C_Cmd(OLED_I2C_PORT, ENABLE);
}

/**
 * @brief 写命令
 */
static void oled_write_cmd(uint8_t cmd)
{
    /* 等待I2C空闲 */
    while (I2C_GetFlagStatus(OLED_I2C_PORT, I2C_FLAG_BUSY));

    /* 发送起始条件 */
    I2C_GenerateSTART(OLED_I2C_PORT, ENABLE);
    while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_MODE_SELECT));

    /* 发送地址 */
    I2C_Send7bitAddress(OLED_I2C_PORT, OLED_I2C_ADDR_8BIT, I2C_Direction_Transmitter);
    while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));

    /* 发送命令标识 0x00 */
    I2C_SendData(OLED_I2C_PORT, 0x00);
    while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_BYTE_TRANSMITTED));

    /* 发送命令 */
    I2C_SendData(OLED_I2C_PORT, cmd);
    while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_BYTE_TRANSMITTED));

    /* 发送停止条件 */
    I2C_GenerateSTOP(OLED_I2C_PORT, ENABLE);
}

/**
 * @brief 写数据
 */
static void oled_write_data(uint8_t data)
{
    while (I2C_GetFlagStatus(OLED_I2C_PORT, I2C_FLAG_BUSY));

    I2C_GenerateSTART(OLED_I2C_PORT, ENABLE);
    while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_MODE_SELECT));

    I2C_Send7bitAddress(OLED_I2C_PORT, OLED_I2C_ADDR_8BIT, I2C_Direction_Transmitter);
    while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));

    /* 发送数据标识 0x40 */
    I2C_SendData(OLED_I2C_PORT, 0x40);
    while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_BYTE_TRANSMITTED));

    I2C_SendData(OLED_I2C_PORT, data);
    while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_BYTE_TRANSMITTED));

    I2C_GenerateSTOP(OLED_I2C_PORT, ENABLE);
}

/**
 * @brief 批量写数据
 */
static void oled_write_data_buffer(const uint8_t *data, uint16_t len)
{
    uint16_t i;

    while (I2C_GetFlagStatus(OLED_I2C_PORT, I2C_FLAG_BUSY));

    I2C_GenerateSTART(OLED_I2C_PORT, ENABLE);
    while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_MODE_SELECT));

    I2C_Send7bitAddress(OLED_I2C_PORT, OLED_I2C_ADDR_8BIT, I2C_Direction_Transmitter);
    while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));

    I2C_SendData(OLED_I2C_PORT, 0x40);
    while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_BYTE_TRANSMITTED));

    for (i = 0; i < len; i++) {
        I2C_SendData(OLED_I2C_PORT, data[i]);
        while (!I2C_CheckEvent(OLED_I2C_PORT, I2C_EVENT_MASTER_BYTE_TRANSMITTED));
    }

    I2C_GenerateSTOP(OLED_I2C_PORT, ENABLE);
}

#elif OLED_USE_SW_I2C

/* 软件I2C引脚控制 */
#define SW_SCL_HIGH()   GPIO_SetBits(OLED_SW_SCL_PORT, OLED_SW_SCL_PIN)
#define SW_SCL_LOW()    GPIO_ResetBits(OLED_SW_SCL_PORT, OLED_SW_SCL_PIN)
#define SW_SDA_HIGH()   GPIO_SetBits(OLED_SW_SDA_PORT, OLED_SW_SDA_PIN)
#define SW_SDA_LOW()    GPIO_ResetBits(OLED_SW_SDA_PORT, OLED_SW_SDA_PIN)

static void oled_i2c_init(void)
{
    GPIO_InitTypeDef GPIO_InitStructure;

    RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOB, ENABLE);

    GPIO_InitStructure.GPIO_Pin = OLED_SW_SCL_PIN | OLED_SW_SDA_PIN;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;
    GPIO_InitStructure.GPIO_OType = GPIO_OType_OD;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;
    GPIO_Init(OLED_SW_SCL_PORT, &GPIO_InitStructure);

    SW_SCL_HIGH();
    SW_SDA_HIGH();
}

static void sw_i2c_delay(void)
{
    volatile uint8_t i = 5;
    while (i--);
}

static void sw_i2c_start(void)
{
    SW_SDA_HIGH();
    SW_SCL_HIGH();
    sw_i2c_delay();
    SW_SDA_LOW();
    sw_i2c_delay();
    SW_SCL_LOW();
}

static void sw_i2c_stop(void)
{
    SW_SDA_LOW();
    SW_SCL_HIGH();
    sw_i2c_delay();
    SW_SDA_HIGH();
    sw_i2c_delay();
}

static void sw_i2c_write_byte(uint8_t data)
{
    uint8_t i;
    for (i = 0; i < 8; i++) {
        if (data & 0x80) {
            SW_SDA_HIGH();
        } else {
            SW_SDA_LOW();
        }
        sw_i2c_delay();
        SW_SCL_HIGH();
        sw_i2c_delay();
        SW_SCL_LOW();
        data <<= 1;
    }
    /* ACK */
    SW_SDA_HIGH();
    sw_i2c_delay();
    SW_SCL_HIGH();
    sw_i2c_delay();
    SW_SCL_LOW();
}

static void oled_write_cmd(uint8_t cmd)
{
    sw_i2c_start();
    sw_i2c_write_byte(OLED_I2C_ADDR_8BIT);
    sw_i2c_write_byte(0x00);
    sw_i2c_write_byte(cmd);
    sw_i2c_stop();
}

static void oled_write_data(uint8_t data)
{
    sw_i2c_start();
    sw_i2c_write_byte(OLED_I2C_ADDR_8BIT);
    sw_i2c_write_byte(0x40);
    sw_i2c_write_byte(data);
    sw_i2c_stop();
}

static void oled_write_data_buffer(const uint8_t *data, uint16_t len)
{
    uint16_t i;
    sw_i2c_start();
    sw_i2c_write_byte(OLED_I2C_ADDR_8BIT);
    sw_i2c_write_byte(0x40);
    for (i = 0; i < len; i++) {
        sw_i2c_write_byte(data[i]);
    }
    sw_i2c_stop();
}

#endif

/*=============================================================================
 *                              公共函数实现
 *============================================================================*/

/**
 * @brief OLED初始化
 */
int bsp_oled_init(void)
{
    /* I2C初始化 */
    oled_i2c_init();
    delay_ms(100);

    /* SSD1306初始化序列 */
    oled_write_cmd(0xAE); /* 关闭显示 */
    oled_write_cmd(0x00); /* 设置低列地址 */
    oled_write_cmd(0x10); /* 设置高列地址 */
    oled_write_cmd(0x40); /* 设置起始行地址 */
    oled_write_cmd(0xB0); /* 设置页地址 */
    oled_write_cmd(0x81); /* 对比度设置 */
    oled_write_cmd(0xCF); /* 对比度值 */
    oled_write_cmd(0xA1); /* 段重映射 */
    oled_write_cmd(0xA6); /* 正常显示 */

    /* 设置复用比 (根据屏幕高度) */
    oled_write_cmd(0xA8);
    if (current_oled_type == OLED_TYPE_096_128X64) {
        oled_write_cmd(0x3F); /* 64MUX */
    } else {
        oled_write_cmd(0x1F); /* 32MUX */
    }

    oled_write_cmd(0xC8); /* COM扫描方向 */
    oled_write_cmd(0xD3); /* 显示偏移 */
    oled_write_cmd(0x00);
    oled_write_cmd(0xD5); /* 时钟分频 */
    oled_write_cmd(0x80);
    oled_write_cmd(0xD9); /* 预充电周期 */
    oled_write_cmd(0xF1);
    oled_write_cmd(0xDA); /* COM引脚配置 */
    if (current_oled_type == OLED_TYPE_096_128X64) {
        oled_write_cmd(0x12);
    } else {
        oled_write_cmd(0x02);
    }
    oled_write_cmd(0xDB); /* VCOMH */
    oled_write_cmd(0x40);
    oled_write_cmd(0x8D); /* 电荷泵 */
    oled_write_cmd(0x14);
    oled_write_cmd(0xAF); /* 开启显示 */

    /* 清屏 */
    bsp_oled_clear();
    bsp_oled_refresh();

    return 0;
}

/**
 * @brief OLED反初始化
 */
void bsp_oled_deinit(void)
{
    bsp_oled_display_off();
}

/**
 * @brief 设置OLED类型
 */
void bsp_oled_set_type(uint8_t type)
{
    current_oled_type = type;
    if (type == OLED_TYPE_096_128X64) {
        current_height = 64;
        current_pages = 8;
    } else {
        current_height = 32;
        current_pages = 4;
    }
}

/**
 * @brief 获取当前OLED类型
 */
uint8_t bsp_oled_get_type(void)
{
    return current_oled_type;
}

/**
 * @brief 开启显示
 */
void bsp_oled_display_on(void)
{
    oled_write_cmd(0x8D);
    oled_write_cmd(0x14);
    oled_write_cmd(0xAF);
}

/**
 * @brief 关闭显示
 */
void bsp_oled_display_off(void)
{
    oled_write_cmd(0x8D);
    oled_write_cmd(0x10);
    oled_write_cmd(0xAE);
}

/**
 * @brief 设置对比度
 */
void bsp_oled_set_contrast(uint8_t contrast)
{
    oled_write_cmd(0x81);
    oled_write_cmd(contrast);
}

/**
 * @brief 反转显示
 */
void bsp_oled_invert_display(uint8_t invert)
{
    oled_write_cmd(invert ? 0xA7 : 0xA6);
}

/**
 * @brief 刷新显示
 */
void bsp_oled_refresh(void)
{
    uint8_t page;

    for (page = 0; page < current_pages; page++) {
        oled_write_cmd(0xB0 + page);
        oled_write_cmd(0x00);
        oled_write_cmd(0x10);
        oled_write_data_buffer(&oled_buffer[OLED_WIDTH * page], OLED_WIDTH);
    }
}

/**
 * @brief 清屏
 */
void bsp_oled_clear(void)
{
    memset(oled_buffer, 0, sizeof(oled_buffer));
}

/**
 * @brief 填充屏幕
 */
void bsp_oled_fill(oled_color_t color)
{
    memset(oled_buffer, color ? 0xFF : 0x00, sizeof(oled_buffer));
}

/**
 * @brief 画点
 */
void bsp_oled_draw_pixel(uint8_t x, uint8_t y, oled_color_t color)
{
    if (x >= OLED_WIDTH || y >= current_height) {
        return;
    }

    if (color == OLED_COLOR_WHITE) {
        oled_buffer[x + (y / 8) * OLED_WIDTH] |= (1 << (y % 8));
    } else {
        oled_buffer[x + (y / 8) * OLED_WIDTH] &= ~(1 << (y % 8));
    }
}

/**
 * @brief 获取点颜色
 */
oled_color_t bsp_oled_get_pixel(uint8_t x, uint8_t y)
{
    if (x >= OLED_WIDTH || y >= current_height) {
        return OLED_COLOR_BLACK;
    }

    return (oled_buffer[x + (y / 8) * OLED_WIDTH] & (1 << (y % 8))) ?
           OLED_COLOR_WHITE : OLED_COLOR_BLACK;
}

/**
 * @brief 画水平线
 */
void bsp_oled_draw_hline(uint8_t x, uint8_t y, uint8_t w, oled_color_t color)
{
    uint8_t i;
    for (i = 0; i < w; i++) {
        bsp_oled_draw_pixel(x + i, y, color);
    }
}

/**
 * @brief 画垂直线
 */
void bsp_oled_draw_vline(uint8_t x, uint8_t y, uint8_t h, oled_color_t color)
{
    uint8_t i;
    for (i = 0; i < h; i++) {
        bsp_oled_draw_pixel(x, y + i, color);
    }
}

/**
 * @brief 画线 (Bresenham算法)
 */
void bsp_oled_draw_line(uint8_t x0, uint8_t y0, uint8_t x1, uint8_t y1, oled_color_t color)
{
    int16_t dx = x1 > x0 ? x1 - x0 : x0 - x1;
    int16_t dy = y1 > y0 ? y1 - y0 : y0 - y1;
    int16_t sx = x0 < x1 ? 1 : -1;
    int16_t sy = y0 < y1 ? 1 : -1;
    int16_t err = dx - dy;
    int16_t e2;

    while (1) {
        bsp_oled_draw_pixel(x0, y0, color);
        if (x0 == x1 && y0 == y1) break;
        e2 = 2 * err;
        if (e2 > -dy) {
            err -= dy;
            x0 += sx;
        }
        if (e2 < dx) {
            err += dx;
            y0 += sy;
        }
    }
}

/**
 * @brief 画矩形
 */
void bsp_oled_draw_rect(uint8_t x, uint8_t y, uint8_t w, uint8_t h, oled_color_t color)
{
    bsp_oled_draw_hline(x, y, w, color);
    bsp_oled_draw_hline(x, y + h - 1, w, color);
    bsp_oled_draw_vline(x, y, h, color);
    bsp_oled_draw_vline(x + w - 1, y, h, color);
}

/**
 * @brief 填充矩形
 */
void bsp_oled_fill_rect(uint8_t x, uint8_t y, uint8_t w, uint8_t h, oled_color_t color)
{
    uint8_t i;
    for (i = 0; i < h; i++) {
        bsp_oled_draw_hline(x, y + i, w, color);
    }
}

/**
 * @brief 画圆 (中点算法)
 */
void bsp_oled_draw_circle(uint8_t x0, uint8_t y0, uint8_t r, oled_color_t color)
{
    int16_t x = r;
    int16_t y = 0;
    int16_t err = 0;

    while (x >= y) {
        bsp_oled_draw_pixel(x0 + x, y0 + y, color);
        bsp_oled_draw_pixel(x0 + y, y0 + x, color);
        bsp_oled_draw_pixel(x0 - y, y0 + x, color);
        bsp_oled_draw_pixel(x0 - x, y0 + y, color);
        bsp_oled_draw_pixel(x0 - x, y0 - y, color);
        bsp_oled_draw_pixel(x0 - y, y0 - x, color);
        bsp_oled_draw_pixel(x0 + y, y0 - x, color);
        bsp_oled_draw_pixel(x0 + x, y0 - y, color);

        y++;
        err += 1 + 2 * y;
        if (2 * (err - x) + 1 > 0) {
            x--;
            err += 1 - 2 * x;
        }
    }
}

/**
 * @brief 填充圆
 */
void bsp_oled_fill_circle(uint8_t x0, uint8_t y0, uint8_t r, oled_color_t color)
{
    int16_t x = r;
    int16_t y = 0;
    int16_t err = 0;

    while (x >= y) {
        bsp_oled_draw_hline(x0 - x, y0 + y, 2 * x + 1, color);
        bsp_oled_draw_hline(x0 - y, y0 + x, 2 * y + 1, color);
        bsp_oled_draw_hline(x0 - x, y0 - y, 2 * x + 1, color);
        bsp_oled_draw_hline(x0 - y, y0 - x, 2 * y + 1, color);

        y++;
        err += 1 + 2 * y;
        if (2 * (err - x) + 1 > 0) {
            x--;
            err += 1 - 2 * x;
        }
    }
}

/**
 * @brief 显示字符
 */
void bsp_oled_draw_char(uint8_t x, uint8_t y, char ch, const oled_font_t *font, oled_color_t color)
{
    uint8_t i, j;
    uint8_t data;
    const uint8_t *p;

    if (ch < 0x20 || ch > 0x7E) {
        ch = ' ';
    }

    p = font->data + (ch - 0x20) * font->width * (font->height / 8);

    for (i = 0; i < font->width; i++) {
        for (j = 0; j < font->height / 8; j++) {
            data = p[i + j * font->width];
            uint8_t k;
            for (k = 0; k < 8; k++) {
                if (data & (1 << k)) {
                    bsp_oled_draw_pixel(x + i, y + j * 8 + k, color);
                } else if (color == OLED_COLOR_WHITE) {
                    bsp_oled_draw_pixel(x + i, y + j * 8 + k, OLED_COLOR_BLACK);
                }
            }
        }
    }
}

/**
 * @brief 显示字符串
 */
void bsp_oled_draw_string(uint8_t x, uint8_t y, const char *str, const oled_font_t *font, oled_color_t color)
{
    while (*str) {
        if (x + font->width > OLED_WIDTH) {
            x = 0;
            y += font->height;
        }
        if (y + font->height > current_height) {
            break;
        }

        bsp_oled_draw_char(x, y, *str, font, color);
        x += font->width;
        str++;
    }
}

/**
 * @brief 格式化显示
 */
void bsp_oled_printf(uint8_t x, uint8_t y, const oled_font_t *font, oled_color_t color, const char *fmt, ...)
{
    char buf[64];
    va_list args;

    va_start(args, fmt);
    vsnprintf(buf, sizeof(buf), fmt, args);
    va_end(args);

    bsp_oled_draw_string(x, y, buf, font, color);
}

/**
 * @brief 显示数字
 */
void bsp_oled_draw_num(uint8_t x, uint8_t y, int32_t num, const oled_font_t *font, oled_color_t color)
{
    char buf[16];
    snprintf(buf, sizeof(buf), "%ld", (long)num);
    bsp_oled_draw_string(x, y, buf, font, color);
}

/**
 * @brief 显示浮点数
 */
void bsp_oled_draw_float(uint8_t x, uint8_t y, float num, uint8_t decimals, const oled_font_t *font, oled_color_t color)
{
    char buf[24];
    char fmt[8];
    snprintf(fmt, sizeof(fmt), "%%.%df", decimals);
    snprintf(buf, sizeof(buf), fmt, num);
    bsp_oled_draw_string(x, y, buf, font, color);
}

/**
 * @brief 显示位图
 */
void bsp_oled_draw_bitmap(uint8_t x, uint8_t y, uint8_t w, uint8_t h, const uint8_t *bitmap)
{
    uint8_t i, j, k;
    uint8_t data;

    for (j = 0; j < (h + 7) / 8; j++) {
        for (i = 0; i < w; i++) {
            data = bitmap[i + j * w];
            for (k = 0; k < 8; k++) {
                if (y + j * 8 + k < current_height) {
                    if (data & (1 << k)) {
                        bsp_oled_draw_pixel(x + i, y + j * 8 + k, OLED_COLOR_WHITE);
                    }
                }
            }
        }
    }
}

/**
 * @brief 获取显存缓冲区指针
 */
uint8_t *bsp_oled_get_buffer(void)
{
    return oled_buffer;
}

/**
 * @brief 获取缓冲区大小
 */
uint16_t bsp_oled_get_buffer_size(void)
{
    return OLED_WIDTH * current_pages;
}

/**
 * @brief 滚动效果
 */
void bsp_oled_scroll_horizontal(uint8_t direction, uint8_t start_page, uint8_t end_page, uint8_t speed)
{
    oled_write_cmd(direction ? 0x27 : 0x26);
    oled_write_cmd(0x00);
    oled_write_cmd(start_page);
    oled_write_cmd(speed);
    oled_write_cmd(end_page);
    oled_write_cmd(0x00);
    oled_write_cmd(0xFF);
    oled_write_cmd(0x2F);
}

void bsp_oled_scroll_stop(void)
{
    oled_write_cmd(0x2E);
}
