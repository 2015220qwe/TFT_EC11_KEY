/**
  ******************************************************************************
  * @file    README_ADVANCED.md
  * @author  TFT_EC11_KEY Project
  * @brief   高级功能使用说明
  ******************************************************************************
  */

# 高级功能说明

本项目现已实现以下高级功能：

## 1. EEPROM配置参数保存 (menu_config)

### 功能特性
- ✅ 自动保存菜单配置到EEPROM/Flash
- ✅ 支持延迟写入(减少Flash擦写次数)
- ✅ CRC32校验,防止数据损坏
- ✅ 支持恢复出厂设置

### 使用示例
```c
/* 定义需要保存的参数 */
int32_t brightness = 50;
uint8_t wifi_enable = 1;

/* 配置参数表 */
menu_param_config_t params[] = {
    {"brightness", MENU_PARAM_TYPE_INT32, &brightness, 50},
    {"wifi", MENU_PARAM_TYPE_UINT8, &wifi_enable, 1}
};

/* 初始化 */
menu_config_init(params, 2);

/* 参数修改后自动延迟保存 */
brightness = 80;
menu_config_mark_dirty();  /* 3秒后自动保存 */

/* 或立即保存 */
menu_config_save(1);

/* 主循环中调用 */
menu_config_task();  /* 处理延迟保存 */
```

## 2. 菜单动画效果 (menu_animation)

### 功能特性
- ✅ 滑动动画 (上下左右)
- ✅ 淡入淡出
- ✅ 缩放动画
- ✅ 弹跳动画
- ✅ 多种缓动函数 (线性/加速/减速/弹跳)

### 使用示例
```c
/* 启动向上滑动动画 */
MENU_ANIM_START_SLIDE_UP();

/* 启动淡入动画 */
MENU_ANIM_START_FADE_IN();

/* 启动弹跳动画(确认反馈) */
MENU_ANIM_START_BOUNCE();

/* 在显示函数中获取动画值 */
int16_t offset = menu_anim_get_value();
uint8_t alpha = menu_anim_get_alpha();
uint8_t progress = menu_anim_get_progress();

/* 主循环中更新动画 */
menu_anim_update();
```

## 3. 菜单项动态管理 (menu_dynamic)

### 功能特性
- ✅ 运行时动态创建/删除菜单项
- ✅ 菜单项显示/隐藏控制
- ✅ 菜单项启用/禁用控制
- ✅ 自动内存管理(内存池)

### 使用示例
```c
/* 初始化动态菜单系统 */
menu_dynamic_init();

/* 快速创建ACTION类型菜单项 */
menu_item_t *item = MENU_CREATE_ACTION("测试", my_callback);

/* 快速创建SWITCH类型菜单项 */
uint8_t state = 0;
menu_item_t *sw_item = MENU_CREATE_SWITCH("WiFi", &state, wifi_callback);

/* 快速创建VALUE类型菜单项 */
int32_t value = 50;
menu_item_t *val_item = MENU_CREATE_VALUE("亮度", &value, 0, 100, 5, brightness_callback);

/* 添加到父菜单 */
menu_dynamic_add_item(parent_menu, item, -1);  /* -1表示添加到末尾 */

/* 显示/隐藏菜单项 */
menu_dynamic_set_visible(item, 0);  /* 隐藏 */
menu_dynamic_set_visible(item, 1);  /* 显示 */

/* 启用/禁用菜单项 */
menu_dynamic_set_enabled(item, 0);  /* 禁用 */
menu_dynamic_set_enabled(item, 1);  /* 启用 */

/* 查找菜单项 */
menu_item_t *found = menu_dynamic_find_item(parent, "WiFi");

/* 删除菜单项 */
menu_dynamic_delete_item(item);
```

## 4. U8G2显示适配层 (bsp_u8g2_port)

### 支持的显示器
- SSD1306 OLED (128x64, 128x32)
- ST7920 LCD
- ST7789 TFT
- 其他U8G2支持的显示器

### 使用示例
```c
#include "u8g2.h"
#include "bsp_u8g2_port.h"

u8g2_t u8g2;

/* 初始化 */
bsp_u8g2_hw_init(&u8g2);

/* 使用U8G2 API绘图 */
u8g2_ClearBuffer(&u8g2);
u8g2_SetFont(&u8g2, u8g2_font_ncenB14_tr);
u8g2_DrawStr(&u8g2, 0, 20, "Hello World!");
u8g2_SendBuffer(&u8g2);
```

## 5. 完整应用示例

参见 `app/main_advanced.c` - 综合演示所有高级功能

## 文件清单

### 中间件层
- `middleware/menu_config.c/h` - EEPROM配置管理
- `middleware/menu_animation.c/h` - 动画效果
- `middleware/menu_dynamic.c/h` - 动态菜单管理

### BSP层
- `bsp/bsp_u8g2_port.c/h` - U8G2显示适配
- `bsp_hal/bsp_ec11_hal.h` - HAL库版本驱动(头文件)

### 应用层
- `app/main_advanced.c` - 高级功能演示

## 性能优化

1. **EEPROM写入优化**
   - 延迟写入机制(默认3秒)
   - 避免频繁擦写Flash
   - CRC校验确保数据完整性

2. **动画性能**
   - 30FPS流畅动画
   - 多种缓动函数
   - 无阻塞设计

3. **内存管理**
   - 静态内存池(无malloc碎片)
   - 可配置池大小
   - 自动回收

## 移植说明

### EEPROM接口实现

用户需要实现以下函数:

```c
int menu_config_eeprom_read(uint32_t addr, uint8_t *buf, uint32_t len);
int menu_config_eeprom_write(uint32_t addr, const uint8_t *buf, uint32_t len);
```

### STM32内部Flash模拟EEPROM示例

```c
/* 使用最后一个扇区模拟EEPROM */
#define EEPROM_BASE_ADDR  0x080E0000  /* 扇区11 */

int menu_config_eeprom_read(uint32_t addr, uint8_t *buf, uint32_t len)
{
    memcpy(buf, (void*)(EEPROM_BASE_ADDR + addr), len);
    return 0;
}

int menu_config_eeprom_write(uint32_t addr, const uint8_t *buf, uint32_t len)
{
    /* 解锁Flash */
    FLASH_Unlock();

    /* 擦除扇区 */
    FLASH_EraseSector(FLASH_Sector_11, VoltageRange_3);

    /* 写入数据 */
    for (uint32_t i = 0; i < len; i += 4) {
        uint32_t data = *(uint32_t*)(buf + i);
        FLASH_ProgramWord(EEPROM_BASE_ADDR + addr + i, data);
    }

    /* 锁定Flash */
    FLASH_Lock();

    return 0;
}
```

## 常见问题

### Q1: 配置保存失败?
A: 检查是否实现了`menu_config_eeprom_read/write`函数

### Q2: 动画卡顿?
A: 确保主循环中调用了`menu_anim_update()`，且循环周期不超过33ms(30FPS)

### Q3: 动态菜单创建失败?
A: 检查内存池是否已满，可增大`MENU_DYNAMIC_POOL_SIZE`

## 后续扩展

- [ ] 添加更多动画效果
- [ ] 支持菜单主题切换
- [ ] 添加触摸屏支持
- [ ] 实现菜单导出/导入功能

---
**更新日期**: 2025-12-01
**版本**: V2.0.0
